{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–∫–ª–∞–¥–∫–∏ - Chic & Chat{% endblock %}

{% block content %}
<div class="container">
    <h1 style="text-align: center; margin-bottom: 2rem;">–ú–æ–∏ –∑–∞–∫–ª–∞–¥–∫–∏ üîñ</h1>
    
    <div id="bookmarksContainer" class="grid-2">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–ª–∞–¥–æ–∫...</div>
    </div>
</div>

<script>
async function loadBookmarks() {
    console.log('Loading bookmarks...');
    
    // Wait for auth to be ready
    const token = localStorage.getItem('authToken');
    console.log('Auth token from localStorage:', token);
    
    try {
        // Check if user is logged in
        if (!token) {
            console.log('No auth token found');
            document.getElementById('bookmarksContainer').innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                    <p class="alert alert-info">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –∑–∞–∫–ª–∞–¥–∫–∏</p>
                    <button onclick="openModal('loginModal')" class="btn" style="margin-top: 1rem;">–í–æ–π—Ç–∏</button>
                </div>
            `;
            return;
        }

        const url = '/api/v1/users/me/bookmarks';
        console.log('Fetching bookmarks from:', url);
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            
            if (response.status === 401) {
                document.getElementById('bookmarksContainer').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                        <p class="alert alert-info">–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ</p>
                        <button onclick="logout(); openModal('loginModal');" class="btn" style="margin-top: 1rem;">–í–æ–π—Ç–∏</button>
                    </div>
                `;
                return;
            }
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const posts = await response.json();
        console.log('Bookmarks loaded successfully!');
        console.log('Number of bookmarks:', posts.length);
        console.log('Bookmarks:', posts);
        displayBookmarks(posts);
    } catch (error) {
        console.error('Error loading bookmarks:', error);
        document.getElementById('bookmarksContainer').innerHTML = `
            <div style="grid-column: 1/-1;">
                <p class="alert alert-error">
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–ª–∞–¥–æ–∫: ${error.message}
                </p>
                <p style="margin-top: 1rem; color: var(--text-light);">
                    –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
                </p>
            </div>
        `;
    }
}

function displayBookmarks(posts) {
    const container = document.getElementById('bookmarksContainer');
    
    if (!posts || posts.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                <p style="font-size: 1.2rem; color: var(--text-light); margin-bottom: 1rem;">
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ üìö
                </p>
                <p style="color: var(--text-light); margin-bottom: 2rem;">
                    –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π –ø–æ—Å—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "üîñ –í –∑–∞–∫–ª–∞–¥–∫–∏"
                </p>
                <a href="/posts" class="btn">–ù–∞–π—Ç–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–æ—Å—Ç—ã</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = posts.map(post => `
        <article class="post-card card fade-in">
            <h3><a href="/post/${post.id}">${escapeHtml(post.post_title)}</a></h3>
            <div class="post-meta">
                <span>üë§ <a href="/profile/${post.author.id}">${escapeHtml(post.author.username)}</a></span>
                <span>‚ù§Ô∏è ${post.likes_count || 0}</span>
                <span>üí¨ ${post.comments_count || 0}</span>
                <span>üìÖ ${formatDate(post.created_at)}</span>
            </div>
            ${post.tags && post.tags.length > 0 ? `
                <div class="tags">
                    ${post.tags.map(tag => `<span class="tag">${escapeHtml(tag.tag_name)}</span>`).join('')}
                </div>
            ` : ''}
            <div class="post-content">
                <p>${escapeHtml(post.post_content.substring(0, 200))}${post.post_content.length > 200 ? '...' : ''}</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <a href="/post/${post.id}" class="btn btn-outline">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</a>
                <button onclick="removeBookmark(${post.id})" class="btn btn-secondary">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </article>
    `).join('');
}

async function removeBookmark(postId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫?')) return;
    
    const token = localStorage.getItem('authToken');
    
    try {
        const response = await fetch(`/api/v1/posts/${postId}/bookmark`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            if (typeof showAlert === 'function') {
                showAlert('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫', 'success');
            }
            loadBookmarks();
        } else {
            const error = await response.json();
            if (typeof showAlert === 'function') {
                showAlert(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }
        }
    } catch (error) {
        console.error('Error removing bookmark:', error);
        if (typeof showAlert === 'function') {
            showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        }
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
}

// Wait for DOM and main.js to load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(loadBookmarks, 500);
    });
} else {
    setTimeout(loadBookmarks, 500);
}
</script>
{% endblock %}
